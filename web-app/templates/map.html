<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Guides</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <script src="/static/tailwind.js"></script>
  <script src="/static/flowbite.js"></script>
  <link href="/static/flowbite.min.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css' type='text/css' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
</head>
<body class="m-4 flex flex-col items-center">
    <div id="toast-warning" class="hidden absolute m-10 z-50 flex items-center justify-center w-max-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow" role="alert">
      <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-yellow-500 bg-yellow-100 rounded-lg">
          <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"/>
          </svg>
          <span class="sr-only">Warning icon</span>
      </div>
      <div class="ms-3 text-sm font-normal">Only one polygon for the farm's border and one line for the rover's path can be created. Use the reset button to start again.</div>
      <button onclick="document.getElementById('toast-warning').classList.add('hidden')" type="button" class="ms-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" aria-label="Close">
          <span class="sr-only">Close</span>
          <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
      </button>
    </div>
  <div class="w-full flex flex-col items-center">
    <div style="height: 80vh; width: 100%;" class="rounded-xl" id="map"></div>
    <div class="mt-4">
      <button type="button" onclick="window.location.reload();" class="py-2.5 px-5 me-2 mb-2 text-sm font-medium text-blue-700 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100">Reset</button>
      <button type="button" onclick="save()" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 focus:outline-none">Save</button>
    </div>
  </div>
  <script>

    let border;
    let path;

    let coordinates = {
      latitude: null,
      longitude: null
    };

    function getLocation() {
      if (navigator) {
        console.log('Geolocation is supported by this browser.');
        navigator.geolocation.getCurrentPosition(function(position) {
          coordinates.latitude = position.coords.latitude;
          coordinates.longitude = position.coords.longitude;
          console.log('Coordinates:', coordinates);
        });
      } else {
        console.error("Geolocation is not supported by this browser.");
      }
    }

    mapboxgl.accessToken = 'pk.eyJ1Ijoic3Noc2hhaWxlc2giLCJhIjoiY2x5eHMyanl4MW1paTJqcWxnNGZocmV3NSJ9.1QBOeolyujwYbYD7vcpB_w';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-streets-v12',
      center: [77.728754, 13.087465],
      zoom: 15
    });

    var Draw = new MapboxDraw();
    map.addControl(Draw, 'top-left');

    map.on('draw.create', handleDrawEvent);
    map.on('draw.update', handleDrawEvent);

    const toast = document.getElementById('toast-warning');
    let draw_data;

    function handleDrawEvent(e) {
      var data = Draw.getAll();
      console.log('Draw data:', data);
      draw_data = data;
      var polygons = data.features.filter(feature => feature.geometry.type === 'Polygon');
      var lineStrings = data.features.filter(feature => feature.geometry.type === 'LineString');

      if (polygons.length > 1) {
        Draw.delete(polygons[1].id);
      }
      if (lineStrings.length > 1) {
        Draw.delete(lineStrings[1].id);
      }

      if (polygons.length > 0 && lineStrings.length > 0) {
        const polygon = turf.polygon(polygons[0].geometry.coordinates);
        const lineString = turf.lineString(lineStrings[0].geometry.coordinates);        
        const isLineWithinPolygon = turf.booleanContains(polygon, lineString);

        if (!isLineWithinPolygon) {
          Draw.delete(lineStrings[0].id);
          showToast("The line must be entirely within the polygon.");
        }
      }
    }

    function save(){
      data = draw_data
      fetch('/save/geojson', {
        method: 'POST', 
        headers: {
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify(data) 
      })
      .then(response => response.json()) 
      .then(data => {
        console.log('Success:', data);
        window.location.href = '/';
      })
      .catch((error) => {
        console.error('Error:', error);
        window.location.href = '/';
      });
    }

    map.on('load', function() {
      console.log('Map loaded');
    });

  </script>
</body>
</html>