<!DOCTYPE html>
<html>
<head>
    <title>Farm Field Path Drawer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div class="p-4 bg-gray-100 flex items-center">
        <input id="search-box" class="px-4 py-2 w-1/3 border rounded" type="text" placeholder="Search for a location">
        <button id="draw-button" class="ml-4 px-4 py-2 bg-blue-500 text-white rounded">Draw Path</button>
        <button id="save-button" class="ml-4 px-4 py-2 bg-green-500 text-white rounded">Save Path</button>
    </div>
    <div id="map" class="flex-grow"></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=drawing,places"></script>
    <script>
        let map;
        let drawingManager;
        let selectedShape;
        let all_overlays = [];
        let drawingEnabled = false;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -34.397, lng: 150.644},
                zoom: 8,
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: false,
                polylineOptions: {
                    clickable: true,
                    editable: true,
                    draggable: true,
                }
            });

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                all_overlays.push(event);
                if (event.type == google.maps.drawing.OverlayType.POLYLINE) {
                    if (selectedShape) {
                        selectedShape.setMap(null);
                    }
                    selectedShape = event.overlay;
                    drawingManager.setDrawingMode(null);
                    drawingEnabled = false;
                }
            });

            drawingManager.setMap(map);

            const input = document.getElementById('search-box');
            const searchBox = new google.maps.places.SearchBox(input);

            map.addListener('bounds_changed', function() {
                searchBox.setBounds(map.getBounds());
            });

            searchBox.addListener('places_changed', function() {
                const places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                let bounds = new google.maps.LatLngBounds();
                places.forEach(function(place) {
                    if (!place.geometry) {
                        console.log("Returned place contains no geometry");
                        return;
                    }
                    if (place.geometry.viewport) {
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });

            document.getElementById('draw-button').addEventListener('click', function() {
                if (!drawingEnabled) {
                    drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYLINE);
                    drawingEnabled = true;
                } else {
                    drawingManager.setDrawingMode(null);
                    drawingEnabled = false;
                }
            });

            document.getElementById('save-button').addEventListener('click', function() {
                savePath();
            });
        }

        function savePath() {
            if (selectedShape) {
                const path = selectedShape.getPath();
                const coordinates = [];
                for (let i = 0; i < path.getLength(); i++) {
                    const latLng = path.getAt(i);
                    coordinates.push({lat: latLng.lat(), lng: latLng.lng()});
                }

                let kml = '<?xml version="1.0" encoding="UTF-8"?>\n';
                kml += '<kml xmlns="http://www.opengis.net/kml/2.2">\n';
                kml += '  <Document>\n';
                kml += '    <Placemark>\n';
                kml += '      <LineString>\n';
                kml += '        <coordinates>\n';

                coordinates.forEach(coord => {
                    kml += `          ${coord.lng},${coord.lat},0\n`;
                });

                kml += '        </coordinates>\n';
                kml += '      </LineString>\n';
                kml += '    </Placemark>\n';
                kml += '  </Document>\n';
                kml += '</kml>';

                fetch('/process_kml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/xml',
                    },
                    body: kml,
                }).then(response => response.text())
                  .then(data => {
                      console.log(data);
                      alert('Path processed successfully!');
                  }).catch(error => {
                      console.error('Error:', error);
                      alert('An error occurred while processing the path.');
                  });
            } else {
                alert("Please draw a path first.");
            }
        }

        google.maps.event.addDomListener(window, 'load', initMap);
    </script>
</body>
</html>