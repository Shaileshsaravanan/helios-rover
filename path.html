<!DOCTYPE html>
<html>
<head>
    <title>Farm Field Path Drawer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="map" class="flex-grow"></div>
    <div id="info" class="p-4 bg-gray-100">
        <button class="px-4 py-2 bg-blue-500 text-white rounded" onclick="savePath()">Save Path</button>
        <pre id="path-coordinates" class="mt-4 p-2 bg-gray-200 rounded"></pre>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=drawing"></script>
    <script>
        let map;
        let drawingManager;
        let selectedShape;
        let all_overlays = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -34.397, lng: 150.644},
                zoom: 8,
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYLINE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYLINE
                    ],
                },
                polylineOptions: {
                    clickable: true,
                    editable: true,
                    draggable: true,
                }
            });

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                all_overlays.push(event);
                if (event.type == google.maps.drawing.OverlayType.POLYLINE) {
                    if (selectedShape) {
                        selectedShape.setMap(null);
                    }
                    selectedShape = event.overlay;
                }
            });

            drawingManager.setMap(map);
        }

        function savePath() {
            if (selectedShape) {
                const path = selectedShape.getPath();
                const coordinates = [];
                for (let i = 0; i < path.getLength(); i++) {
                    const latLng = path.getAt(i);
                    coordinates.push({lat: latLng.lat(), lng: latLng.lng()});
                }
                document.getElementById('path-coordinates').textContent = JSON.stringify(coordinates, null, 2);
                
                // Generate KML
                let kml = '<?xml version="1.0" encoding="UTF-8"?>\n';
                kml += '<kml xmlns="http://www.opengis.net/kml/2.2">\n';
                kml += '  <Document>\n';
                kml += '    <Placemark>\n';
                kml += '      <LineString>\n';
                kml += '        <coordinates>\n';

                coordinates.forEach(coord => {
                    kml += `          ${coord.lng},${coord.lat},0\n`;
                });

                kml += '        </coordinates>\n';
                kml += '      </LineString>\n';
                kml += '    </Placemark>\n';
                kml += '  </Document>\n';
                kml += '</kml>';

                const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'path.kml';
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert("Please draw a path first.");
            }
        }

        google.maps.event.addDomListener(window, 'load', initMap);
    </script>
</body>
</html>